<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="120">
    <title>GitHub Pull Requests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: black;
            color: white;
        }

        .repository {
            margin-bottom: 20px;
        }

        .pr {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }

        .pr.blue {
            background-color: #add8e6;
        }

        .pr.red {
            background-color: #f08080;
        }

        .pr.yellow {
            animation: pulse 1.5s infinite;
            background-color: #ffeb3b;
        }

        @keyframes pulse {
            0% {
                background-color: #ffeb3b;
            }
            50% {
                background-color: #fff176;
            }
            100% {
                background-color: #ffeb3b;
            }
        }

        .timestamp {
            font-size: 0.6em;
            color: #ccc;
            margin-left: 10px;
        }
    </style>
    <script src="./github.js"></script>
</head>
<body>
<h1>
    GitHub Open Pull Requests
    <span class="timestamp" id="timestamp"></span>
</h1>
<div id="content"></div>
<script>
    const token = localStorage.getItem('token');
    if (!token) {
        alert('GitHub token is missing! Please set it in localStorage with the key "token".');
        throw new Error('GitHub token not found in localStorage.');
    }

    const state = {};

    async function fetchPullRequests(repo) {
        const url = `https://api.github.com/repos/${repo}/pulls`;
        const response = await fetch(url, {
            headers: {Authorization: `token ${token}`}
        });
        if (!response.ok) {
            console.error(`Failed to fetch pull requests for ${repo}:`, response.statusText);
            return [];
        }
        return response.json();
    }

    async function fetchCheckRuns(repo, pr) {
        const url = `https://api.github.com/repos/${repo}/commits/${pr.head.sha}/check-runs`;
        const response = await fetch(url, {
            headers: {Authorization: `token ${token}`}
        });
        if (!response.ok) {
            console.error(`Failed to fetch check runs for PR ${pr.number} in ${repo}:`, response.statusText);
            return {check_runs: []};
        }
        return response.json();
    }

    function getPRColor(checkRuns) {
        const statuses = checkRuns.map(run => run.conclusion);
        if (statuses.includes(null)) return 'yellow';
        if (statuses.includes('failure')) return 'red';
        return 'blue';
    }

    function hasPRChanged(oldPR, newPR) {
        return (
            !oldPR ||
            oldPR.title !== newPR.title ||
            oldPR.number !== newPR.number ||
            oldPR.color !== newPR.color
        );
    }

    function updateTimestamp() {
        const timestampElement = document.getElementById('timestamp');
        const now = new Date();
        timestampElement.textContent = `(Last updated: ${now.toLocaleTimeString()})`;
    }

    async function renderPRs() {
        for (const repo of GITHUB_REPOS) {
            const pullRequests = await fetchPullRequests(repo);
            const currentPRs = {};

            for (const pr of pullRequests) {
                const checkRunsData = await fetchCheckRuns(repo, pr);
                const color = getPRColor(checkRunsData.check_runs);

                const prData = {title: pr.title, number: pr.number, color};
                currentPRs[pr.number] = prData;

                if (!state[repo]) state[repo] = {};
                if (hasPRChanged(state[repo][pr.number], prData)) {
                    const repoDiv = document.getElementById(repo) || createRepoDiv(repo);
                    const prDiv = document.createElement('div');
                    prDiv.classList.add('pr', color);
                    prDiv.innerHTML = `<a href="${pr.html_url}" target="_blank">#${pr.number} - ${pr.title}</a>`;
                    const existingPRDiv = document.getElementById(`${repo}-${pr.number}`);
                    if (existingPRDiv) existingPRDiv.replaceWith(prDiv);
                    else repoDiv.appendChild(prDiv);
                    prDiv.id = `${repo}-${pr.number}`;
                }
            }

            if (state[repo]) {
                for (const prNumber of Object.keys(state[repo])) {
                    if (!currentPRs[prNumber]) {
                        const prDiv = document.getElementById(`${repo}-${prNumber}`);
                        if (prDiv) prDiv.remove();
                    }
                }
            }

            state[repo] = currentPRs;
        }

        updateTimestamp();
    }

    function createRepoDiv(repo) {
        const content = document.getElementById('content');
        const repoDiv = document.createElement('div');
        repoDiv.classList.add('repository');
        repoDiv.id = repo;
        repoDiv.innerHTML = `<h2>${repo}</h2>`;
        content.appendChild(repoDiv);
        return repoDiv;
    }

    repeatedly(renderPRs);
</script>
</body>
</html>