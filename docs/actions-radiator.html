<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="github.js"></script>
    <meta http-equiv="refresh" content="120">
    <title>PR Radiator</title>
    <style>
      body {
        margin: 0;
        padding: 10px;
        box-sizing: border-box;
        font-family: Helvetica, Arial, sans-serif;
        background-color: #000;
      }

      .logout,
      .add-token {
        display: inline-block;
        margin: 10px;
      }

      input[type="text"],
      button {
        margin: 5px;
        padding: 10px;
        font-size: 16px;
      }

      button {
        background-color: #f0f0f0; /* Pastel button color */
        border: none;
        cursor: pointer;
      }

      button:hover {
        background-color: #e0e0e0;
      }

      .cardContainer {
        padding: 32px;
        box-sizing: border-box;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .card {
        display: flex;
        flex-direction: row;
          gap: 32px;
        padding: 32px;
        box-sizing: border-box;
      }

      .card img {
          max-height: 80px;
          width: auto;
      }

      .title {
        font-size: 2em;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .repo-name {
        font-size: 4em;
        color: white;
        -webkit-text-stroke: 2px black;
      }

      .repo-name,
      .title,
      .branch-name {
        margin-bottom: 10px;
      }

      @keyframes pulseYellow {
          0% { background-color: #f0f000; }
          50% { background-color: #f0f0a0; }
          100% { background-color: #f0f000; }
      }
      @keyframes pulseGray {
          0% { background-color: #808080 }
          50% { background-color: #a0a0a0 }
          100% { background-color: #808080 }
      }
      @keyframes pulseBlue {
        0% { background-color: #428ac8 }
        50% { background-color: #72a2c8 }
        100% { background-color: #428ac8 }
      }
      @keyframes pulseRed {
        0% { background-color: #c84242 }
        50% { background-color: #c87272 }
        100% { background-color: #c84242 }
      }
      .card { background-color: #808080 }
      .card.checks-passed { background-color: #428ac8; }
      .card.checks-failed { background-color: #c84242; }
      .card.status-in_progress { background-color: #f0f000;  animation: 2s infinite alternate pulseYellow; }
    </style>
  </head>
  <body>
    <div id="prContainer" class="cardContainer"></div>
    <div class="logout">
      <button onclick="logout()">Logout</button>
    </div>
    <div class="add-token">
      <input type="text" id="tokenInput" placeholder="Enter GitHub token" />
      <button onclick="saveToken()">Save Token</button>
    </div>
    <script>
      const repos = [
        "Opetushallitus/cas",
        "Opetushallitus/cas-oppija",
        "Opetushallitus/henkilo-ui",
        "Opetushallitus/henkilotietomuutos",
        "Opetushallitus/kayttooikeus",
        "Opetushallitus/koodisto",
        "Opetushallitus/koodisto-app",
        "Opetushallitus/login-notifications",
        "Opetushallitus/oppijanumerorekisteri",
        "Opetushallitus/organisaatio",
        "Opetushallitus/osoitepalvelu",
        "Opetushallitus/palveluvayla",
        "Opetushallitus/rekisterointi",
        "Opetushallitus/service-provider",
        "Opetushallitus/varda-rekisterointi",
        "Opetushallitus/vtj",
        "Opetushallitus/yleiskayttoiset-palvelut",
      ];
      let token = localStorage.getItem("token") || "";

      function saveToken() {
        token = document.getElementById("tokenInput").value;
        localStorage.setItem("token", token);
      }

      function logout() {
        localStorage.removeItem("token");
        token = "";
      }

      document
        .getElementById("tokenInput")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            saveToken();
          }
        });

      const runRepoAndBranchName = run => `${run.head_repository.name} - ${run.head_branch}`
      const runTitle = run => run.head_commit.message.split("\n")[0]
      const runAuthor = run => `${run.created_at} ${run.actor.login}`

      function updateCard(card, run) {
          fetchCheckRuns(run.head_repository.full_name, run.head_sha)
              .then(checkRuns => {
                  card.querySelector("img").src = run.actor.avatar_url
                  card.getElementsByClassName("repo-name")[0].innerText = runRepoAndBranchName(run)
                  card.getElementsByClassName("title")[0].innerText = runTitle(run)
                  card.getElementsByClassName("branch-name")[0].innerText = runAuthor(run)
                  card.className = `card status-${run.status}`
                  const inProgress = checkRuns.check_runs.some(_ => _.status !== "completed")
                  const checksCancelled = checkRuns.check_runs.some(
                      (checkRun) => checkRun.conclusion === "cancelled"
                  );
                  const allChecksPassed = checkRuns.check_runs.every(
                      (checkRun) => ["success", "skipped"].includes(checkRun.conclusion)
                  );
                  card.className +=
                      checksCancelled ? " checks-cancelled" :
                      allChecksPassed ? " checks-passed" :
                      " checks-failed"
              })
      }

      function addRunToCard(run) {
        console.log(run)
        const cardwrapper = document.createElement("div");
        cardwrapper.className = "pr-card";
        cardwrapper.dataset.runId = run.id;
        const img = document.createElement("img");
        cardwrapper.appendChild(img);

        const card = document.createElement("div");
        const repoNameElement = document.createElement("div");
        repoNameElement.className = "repo-name";
        card.appendChild(repoNameElement);

        const titleElement = document.createElement("div");
        titleElement.className = "title";
        card.appendChild(titleElement);

        const branchNameElement = document.createElement("div");
        branchNameElement.className = "branch-name";
        card.appendChild(branchNameElement);
        cardwrapper.appendChild(card)
        updateCard(cardwrapper, run)
        const prContainer = document.getElementById("prContainer");
        prContainer.appendChild(cardwrapper);
      }

      async function updateActions() {
        let allRuns = await Promise.all(repos.map(fetchActionRuns))
        allRuns = allRuns.flat()
        allRuns.sort((a, b) => b.created_at < a.created_at ? -1 : 1);
        allRuns.forEach(run => {
              const container = document.getElementById("prContainer");
              const existingCards = Array.from(
                container.getElementsByClassName("card")
              ).filter(
                (card) => card.dataset.runId === run.id.toString()
              );

              const existingCard = existingCards.find(
                (card) => card.dataset.runId === run.id.toString()
              );
              if (existingCard) {
                updateCard(existingCard, run);
              } else {
                addRunToCard(run);
              }

              existingCards
                .filter(
                  (card) =>
                    !allRuns.some((run) => run.id.toString() === card.dataset.runId)
                )
                .forEach((card) => prContainer.removeChild(card));
            });
      }

      window.onload = function () {
        updateActions();
      };

      setInterval(updateActions, 5000);
    </script>
  </body>
</html>
